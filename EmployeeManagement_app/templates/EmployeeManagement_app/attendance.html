{% extends 'base/base.html' %} 

{% load static %} 

{% block title %}Attendance{% endblock title %} 

{% block content %}
<main class="content flex-grow-1" style="padding-top: 80px">
  <div class="container-fluid">
    <!-- Page Header -->
    <div class="page-header">
      <div class="container">
        <div class="row align-items-center">
          <div class="col-md-8">
            <h2 class="mb-1">
              <i class="bi bi-calendar-check"></i> Attendance Management
            </h2>
            <p class="employee-info mb-0">
              <i class="bi bi-person-badge"></i> {{ employee.employee_id }} - {{ employee.full_name }}
            </p>
          </div>

          <div class="col-md-4 text-md-end">
            <div class="d-flex align-items-center justify-content-md-end">
              <i class="bi bi-calendar-event me-2"></i>
              <span id="current-date"></span>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Mark Attendance Form (Hidden) -->
    <form id="attendance-form" method="post" style="display: none">
      {% csrf_token %}
      <input type="hidden" name="mark_attendance" value="1" />
    </form>

    <!-- Mark Attendance & Summary Row -->
    <div class="row g-4 mb-5">
      <!-- Mark Attendance Card -->
      <div class="col-lg-6">
        <div class="card h-100 {% if attendance_marked_today %}border-success{% else %}border-primary{% endif %}">
          <div class="card-header {% if attendance_marked_today %}bg-success text-white{% else %}bg-primary text-white{% endif %}">
            <h5 class="card-title mb-0">
              <i class="bi bi-clock-fill"></i> Today's Attendance
            </h5>
          </div>
          <div class="card-body text-center">
            {% if attendance_marked_today %}
            <div class="empty-state">
              <i class="bi bi-check-circle-fill text-success" style="font-size: 5rem"></i>
              <h3 class="text-success mt-3">Already Marked!</h3>
              <p class="text-muted">
                You've successfully marked your attendance for today.
              </p>
              <div class="mt-4">
                <span class="badge bg-success px-4 py-2 fs-6">
                  <i class="bi bi-calendar-check"></i> Present - {{ "now"|date:"M d, Y" }}
                </span>
              </div>
            </div>
            {% else %}
            <div class="attendance-marker">
              <div class="clock-animation mb-4">
                <i class="bi bi-clock" style="font-size: 5rem; color: #007bff"></i>
              </div>
              <h3 class="mb-3">Ready to Mark Attendance?</h3>
              <p class="text-muted mb-4">
                Click the button below to mark yourself present for today.
              </p>
              <button type="button" class="btn btn-success btn-lg px-5 py-3" onclick="markAttendance()">
                <i class="bi bi-check-circle"></i> Mark Present
              </button>
              <div class="mt-3">
                <small class="text-muted">
                  <i class="bi bi-info-circle"></i> Current time:
                  <span id="live-time"></span>
                </small>
              </div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Monthly Summary -->
      <div class="col-lg-6">
        <div class="card h-100">
          <div class="card-header">
            <h5 class="card-title mb-0">
              <i class="bi bi-bar-chart"></i> <span id="summary-title">{{ period_label }}</span>
            </h5>
          </div>
          <div class="card-body">
            <div class="row text-center g-3">
              <div class="col-4">
                <div class="metric-box">
                  <div class="metric-number text-success" id="present-count">
                    {{ present_count }}
                  </div>
                  <div class="metric-label">Days Present</div>
                </div>
              </div>
              <div class="col-4">
                <div class="metric-box">
                  <div class="metric-number text-warning" id="leave-count">
                    {{ leave_count }}
                  </div>
                  <div class="metric-label">Days Leave</div>
                </div>
              </div>
              <div class="col-4">
                <div class="metric-box">
                  <div class="metric-number text-danger" id="absent-count">
                    {{ absent_count }}
                  </div>
                  <div class="metric-label">Days Absent</div>
                </div>
              </div>
            </div>

            <div class="mt-4">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <small class="text-muted">Attendance Rate</small>
                <small class="text-muted"><span id="attendance-rate">{{ attendance_rate }}</span>%</small>
              </div>
              <div class="progress" style="height: 8px; border-radius: 10px">
                <div id="attendance-progress"
                  class="progress-bar {% if attendance_rate >= 90 %}bg-success{% elif attendance_rate >= 75 %}bg-warning{% else %}bg-danger{% endif %}"
                  role="progressbar"
                  style="width: {{ attendance_rate }}%; border-radius: 10px;"
                  aria-valuenow="{{ attendance_rate }}"
                  aria-valuemin="0"
                  aria-valuemax="100">
                </div>
              </div>
              <div class="mt-2 text-center">
                <small class="text-muted">
                  <span id="present-total">{{ present_count }}</span> of 
                  <span id="working-days-total">{{ total_working_days }}</span> working days
                </small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Attendance Records -->
    <div class="card">
      <div class="card-header">
        <div class="row align-items-center">
          <div class="col-md-8">
            <h5 class="card-title mb-0">
              <i class="bi bi-calendar3"></i> Attendance Records
            </h5>
          </div>
          <div class="col-md-4">
            <div class="btn-group w-100" role="group">
              <button type="button" class="btn btn-outline-primary btn-sm period-btn active" data-period="current">
                This Month
              </button>
              <button type="button" class="btn btn-outline-primary btn-sm period-btn" data-period="last">
                Last Month
              </button>
              <button type="button" class="btn btn-outline-primary btn-sm period-btn" data-period="all">
                All Time
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="card-body">
        <!-- Loading Spinner -->
        <div id="loading-spinner" class="text-center py-5" style="display: none;">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2 text-muted">Loading attendance data...</p>
        </div>

        <!-- Attendance Records Table -->
        <div id="attendance-table-container">
          {% if attendance_records %}
          <div class="table-responsive">
            <table class="table table-hover" id="attendance-table">
              <thead>
                <tr>
                  <th><i class="bi bi-calendar-date"></i> Date</th>
                  <th><i class="bi bi-calendar-week"></i> Day</th>
                  <th><i class="bi bi-check-circle"></i> Status</th>
                  <th><i class="bi bi-clock-history"></i> Time</th>
                  <th><i class="bi bi-bar-chart"></i> Performance</th>
                </tr>
              </thead>
              <tbody id="attendance-tbody">
                {% for record in attendance_records %}
                <tr class="fade-in-up">
                  <td><strong>{{ record.date|date:"M d, Y" }}</strong></td>
                  <td><span class="text-muted">{{ record.date|date:"l" }}</span></td>
                  <td>
                    {% if record.status == 'Present' %}
                    <span class="badge bg-success">
                      <i class="bi bi-check-circle"></i> Present
                    </span>
                    {% elif record.status == 'Absent' %}
                    <span class="badge bg-danger">
                      <i class="bi bi-x-circle"></i> Absent
                    </span>
                    {% else %}
                    <span class="badge bg-warning">
                      <i class="bi bi-calendar-x"></i> Leave
                    </span>
                    {% endif %}
                  </td>
                  <td class="text-muted">
                    <i class="bi bi-clock"></i>
                    {% if record.status == 'Present' %}
                      {% if record.marked_time %}
                        {{ record.marked_time|time:"g:i A" }}
                      {% else %}
                        09:00 AM
                      {% endif %}
                    {% else %}
                      --
                    {% endif %}
                  </td>
                  <td>
                    <div class="d-flex align-items-center">
                      <div class="progress me-2" style="width: 60px; height: 6px">
                        <div class="progress-bar {% if record.status == 'Present' %}bg-success{% elif record.status == 'Leave' %}bg-warning{% else %}bg-danger{% endif %}"
                          role="progressbar"
                          style="width: {% if record.status == 'Present' %}100{% elif record.status == 'Leave' %}50{% else %}0{% endif %}%">
                        </div>
                      </div>
                      <small class="text-muted">
                        {% if record.status == 'Present' %} Excellent {% elif record.status == 'Leave' %} On Leave {% else %} Absent {% endif %}
                      </small>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <div class="text-center mt-4">
            <button class="btn btn-outline-primary" id="export-btn" onclick="exportAttendanceReport()">
              <i class="bi bi-download"></i> Export Attendance Report
            </button>
          </div>
          {% else %}
          <div class="empty-state" id="empty-state">
            <i class="bi bi-calendar-x" style="font-size: 4rem; color: #6c757d"></i>
            <h4>No Attendance Records</h4>
            <p>No attendance records found for this period. Start by marking your attendance!</p>
            {% if not attendance_marked_today %}
            <button type="button" class="btn btn-primary mt-3" onclick="markAttendance()">
              <i class="bi bi-plus-circle"></i> Mark First Attendance
            </button>
            {% endif %}
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</main>

<script>
  // Store current period for export
  let currentPeriod = 'current';
  
  // Function to update the current date
  function updateDate() {
    const dateString = new Date().toLocaleDateString('en-US', {
      weekday: 'long',   // e.g., Sunday
      year: 'numeric',   // e.g., 2025
      month: 'long',     // e.g., August
      day: 'numeric'     // e.g., 24
    });

    const dateElement = document.getElementById('current-date');
    if (dateElement) {
      dateElement.textContent = dateString;
    }
  }

  // Initialize and refresh every midnight
  document.addEventListener('DOMContentLoaded', function () {
    updateDate();                // Set immediately
    setInterval(updateDate, 60000); // Refresh every minute
  });

// Function to mark attendance
function markAttendance() {
  if (confirm("Are you sure you want to mark your attendance for today?")) {
    document.getElementById("attendance-form").submit();
  }
}

// Function to export attendance report
function exportAttendanceReport() {
  const employeeId = '{{ employee.employee_id }}';
  const exportBtn = document.getElementById('export-btn');
  
  // Show loading state
  const originalText = exportBtn.innerHTML;
  exportBtn.innerHTML = '<i class="bi bi-clock-history"></i> Generating...';
  exportBtn.disabled = true;
  
  // Build URL with current period
  const exportUrl = `{% url 'export-attendance' employee.employee_id %}?period=${currentPeriod}`;
  
  // Create a temporary link element and trigger download
  const link = document.createElement('a');
  link.href = exportUrl;
  link.download = ''; // Let the server determine filename
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  // Reset button state after a short delay
  setTimeout(() => {
    exportBtn.innerHTML = originalText;
    exportBtn.disabled = false;
  }, 2000);
}

// Function to update attendance data
async function updateAttendanceData(period) {
  const loadingSpinner = document.getElementById('loading-spinner');
  const tableContainer = document.getElementById('attendance-table-container');
  
  // Update current period for export
  currentPeriod = period;
  
  // Show loading spinner
  loadingSpinner.style.display = 'block';
  tableContainer.style.opacity = '0.5';
  
  try {
    const response = await fetch(`?period=${period}`, {
      method: 'GET',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
      }
    });
    
    if (!response.ok) throw new Error('Network response was not ok');
    
    const data = await response.json();
    
    // Update summary statistics with animation
    updateMetricWithAnimation('present-count', data.present_count);
    updateMetricWithAnimation('absent-count', data.absent_count);
    updateMetricWithAnimation('leave-count', data.leave_count);
    updateMetricWithAnimation('attendance-rate', data.attendance_rate);
    
    document.getElementById('present-total').textContent = data.present_count;
    document.getElementById('working-days-total').textContent = data.total_working_days;
    document.getElementById('summary-title').textContent = data.period_label;
    
    // Update progress bar
    const progressBar = document.getElementById('attendance-progress');
    progressBar.style.width = data.attendance_rate + '%';
    progressBar.setAttribute('aria-valuenow', data.attendance_rate);
    
    progressBar.className = 'progress-bar';
    if (data.attendance_rate >= 90) {
      progressBar.classList.add('bg-success');
    } else if (data.attendance_rate >= 75) {
      progressBar.classList.add('bg-warning');
    } else {
      progressBar.classList.add('bg-danger');
    }
    
    // Update attendance table
    updateAttendanceTable(data.records);
    
  } catch (error) {
    console.error('Error updating attendance data:', error);
    alert('Error loading attendance data. Please try again.');
  } finally {
    loadingSpinner.style.display = 'none';
    tableContainer.style.opacity = '1';
  }
}

// Function to update metric with animation
function updateMetricWithAnimation(elementId, newValue) {
  const element = document.getElementById(elementId);
  element.classList.add('updating');
  element.textContent = newValue;
  setTimeout(() => element.classList.remove('updating'), 500);
}

// Function to update attendance table
function updateAttendanceTable(records) {
  const tbody = document.getElementById('attendance-tbody');
  const attendanceTable = document.getElementById('attendance-table');
  const exportBtn = document.getElementById('export-btn');
  const emptyState = document.getElementById('empty-state');
  
  if (records.length === 0) {
    // Hide table and export button, show empty state
    attendanceTable.closest('.table-responsive').style.display = 'none';
    exportBtn.closest('.text-center').style.display = 'none';
    
    // Show or update empty state
    if (!emptyState) {
      const emptyStateHtml = `
        <div class="empty-state" id="empty-state">
          <i class="bi bi-calendar-x" style="font-size: 4rem; color: #6c757d"></i>
          <h4>No Attendance Records</h4>
          <p>No attendance records found for this period.</p>
        </div>
      `;
      document.getElementById('attendance-table-container').innerHTML = emptyStateHtml;
    } else {
      emptyState.style.display = 'block';
    }
    return;
  } else {
    // Show table and export button, hide empty state
    attendanceTable.closest('.table-responsive').style.display = 'block';
    exportBtn.closest('.text-center').style.display = 'block';
    if (emptyState) {
      emptyState.style.display = 'none';
    }
  }
  
  tbody.innerHTML = '';
  records.forEach((record, index) => {
    const row = document.createElement('tr');
    row.className = 'fade-in-up';
    row.style.opacity = '0';
    row.style.transform = 'translateY(20px)';
    
    let statusBadge = '';
    let progressWidth = '100'; // CHANGED: Always 100% width for visual consistency
    let progressClass = 'bg-danger';
    let performanceText = 'Absent';
    
    if (record.status === 'Present') {
      statusBadge = '<span class="badge bg-success"><i class="bi bi-check-circle"></i> Present</span>';
      progressClass = 'bg-success';
      performanceText = 'Excellent';
    } else if (record.status === 'Leave') {
      statusBadge = '<span class="badge bg-warning"><i class="bi bi-calendar-x"></i> Leave</span>';
      progressClass = 'bg-warning';
      performanceText = 'On Leave';
    } else {
      statusBadge = '<span class="badge bg-danger"><i class="bi bi-x-circle"></i> Absent</span>';
      progressClass = 'bg-danger'; // CHANGED: Full red bar for absent
      performanceText = 'Absent';
    }
    
    row.innerHTML = `
      <td><strong>${record.date_formatted}</strong></td>
      <td><span class="text-muted">${record.day}</span></td>
      <td>${statusBadge}</td>
      <td class="text-muted"><i class="bi bi-clock"></i> ${record.time}</td>
      <td>
        <div class="d-flex align-items-center">
          <div class="progress me-2" style="width: 60px; height: 6px">
            <div class="progress-bar ${progressClass}" role="progressbar" style="width: ${progressWidth}%"></div>
          </div>
          <small class="text-muted">${performanceText}</small>
        </div>
      </td>
    `;
    
    tbody.appendChild(row);
    setTimeout(() => {
      row.style.opacity = '1';
      row.style.transform = 'translateY(0)';
    }, index * 100);
  });
}

// Period button click handlers
document.addEventListener('DOMContentLoaded', function() {
  const periodButtons = document.querySelectorAll('.period-btn');
  periodButtons.forEach(button => {
    button.addEventListener('click', async function() {
      periodButtons.forEach(btn => btn.classList.remove('active', 'loading'));
      this.classList.add('active', 'loading');
      const period = this.getAttribute('data-period');
      currentPeriod = period; // Update current period
      try {
        await updateAttendanceData(period);
      } finally {
        this.classList.remove('loading');
      }
    });
  });
});

// Live time and date updater
function updateTime() {
  const now = new Date();
  const timeString = now.toLocaleTimeString("en-US", {
    hour: "2-digit", minute: "2-digit", second: "2-digit", hour12: true,
  });
  const liveTimeElement = document.getElementById("live-time");
  if (liveTimeElement) liveTimeElement.textContent = timeString;
}

function updateDate() {
  const dateString = new Date().toLocaleDateString("en-US", {
    weekday: "long", year: "numeric", month: "long", day: "numeric",
  });
  const currentDateElement = document.getElementById("current-date");
  if (currentDateElement) currentDateElement.textContent = dateString;
}

// Initialize time and date updates
document.addEventListener('DOMContentLoaded', function() {
  updateDate();
  updateTime();
  setInterval(updateTime, 1000);
  setInterval(updateDate, 60000);
});

// Clock animation
document.addEventListener("DOMContentLoaded", function () {
  const clockIcon = document.querySelector(".clock-animation i");
  if (clockIcon) {
    setInterval(() => {
      clockIcon.style.transform = "rotate(360deg)";
      setTimeout(() => clockIcon.style.transform = "rotate(0deg)", 500);
    }, 3000);
  }
});

// Auto-refresh attendance when marked
if (window.location.search.includes('attendance_marked=true')) {
  const url = new URL(window.location);
  url.searchParams.delete('attendance_marked');
  window.history.replaceState({}, document.title, url);
  const activeButton = document.querySelector('.period-btn.active');
  if (activeButton) updateAttendanceData(activeButton.getAttribute('data-period'));
}

// Refresh after successful marking
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.get('success') === 'attendance_marked') {
  setTimeout(() => {
    const activeButton = document.querySelector('.period-btn.active');
    if (activeButton) updateAttendanceData(activeButton.getAttribute('data-period'));
  }, 1000);
}
</script>

{% endblock content %}