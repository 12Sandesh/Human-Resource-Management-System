{% extends 'base/base.html' %}
{% load static %}

{% block title %}Payroll{% endblock title %}

{% block content %}

<main class="content flex-grow-1" style="padding-top: 80px;">
    <div class="container-fluid">
        <!-- Page Header -->
        <div class="page-header">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h2 class="mb-1">
                            <i class="bi bi-cash-coin"></i> Payroll Information
                        </h2>
                        <p class="employee-info mb-0">
                            <i class="bi bi-person-badge"></i> {{ employee.employee_id }} - {{ employee.full_name }}
                        </p>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <div class="d-flex align-items-center justify-content-md-end">
                            <span class="badge bg-light text-dark px-3 py-2">
                                <i class="bi bi-calendar-event me-1"></i>
                                Financial Year: <strong>2025</strong>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Current Salary Overview -->
{% if payroll_records %}
{% with latest_payroll=payroll_records.0 %}
<section class="salary-overview mb-5">
    <div class="card border-success shadow-sm rounded-3">
        <div class="card-header bg-success text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-cash-stack"></i> Latest Payroll - {{ latest_payroll.payment_date|date:"F Y" }}
                </h5>
                <span class="badge bg-light text-dark px-3 py-1">
                    <i class="bi bi-check-circle"></i> Processed
                </span>
            </div>
        </div>

<!-- Current Salary Overview -->
        <div class="card-body p-0">
            <!-- Salary Breakdown -->
            <div class="row g-0">
                <div class="col-md-4 p-4 border-end">
                    <div class="text-center">
                        <div class="metric-box">
                            <div class="metric-number text-primary">
                                ${{ latest_payroll.basic_salary|floatformat:2 }}
                            </div>
                            <div class="metric-label">Basic Salary</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 p-4 border-end">
                    <div class="text-center">
                        <div class="metric-box">
                            <div class="metric-number text-info">
                                +${{ latest_payroll.allowances|floatformat:2 }}
                            </div>
                            <div class="metric-label">Allowances</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 p-4">
                    <div class="text-center">
                        <div class="metric-box">
                            <div class="metric-number text-danger">
                                -${{ latest_payroll.deductions|floatformat:2 }}
                            </div>
                            <div class="metric-label">Deductions</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Net Salary & Payment Info (inside same container) -->
            <div class="bg-light p-4 border-top">
                <div class="row align-items-center">
                    <!-- Net Salary -->
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <div class="net-salary-icon">
                                    <i class="bi bi-wallet2"></i>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-success mb-0">
                                    ${{ latest_payroll.net_salary|floatformat:2 }}
                                </h3>
                                <p class="text-muted mb-0">Total Net Salary</p>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Info -->
                    <div class="col-md-6 text-md-end">
                        <div class="payment-info">
                            <p class="mb-1">
                                <i class="bi bi-calendar-check text-success"></i>
                                <strong>Paid on:</strong> {{ latest_payroll.payment_date|date:"F d, Y" }}
                            </p>
                            <p class="mb-0 text-muted">
                                <i class="bi bi-bank"></i> Direct Deposit
                            </p>
                            <p class="mb-0 text-muted mt-2">
                                <i class="bi bi-info-circle"></i> Next payment:
                                <strong>Oct 1, 2025</strong>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div> <!-- card-body -->
    </div> <!-- card -->






                <!-- Equal Height Row: Yearly Summary & Tax Information -->
                <div class="row mb-5 equal-height-row">
                    <!-- Annual Earnings Summary -->
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-graph-up"></i> Annual Earnings Summary - 2025
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row h-100">
                                    <div class="col-md-6">
                                        <div class="earnings-chart-container">
                                            <canvas id="earningsChart" width="400" height="250"></canvas>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="annual-stats">
                                            <div class="stat-item">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <h6 class="mb-1">Total Earnings (YTD)</h6>
                                                        <small class="text-muted">Jan - {{ latest_payroll.payment_date|date:"M" }} 2025</small>
                                                    </div>
                                                    <div class="text-end">
                                                        <h4 class="text-success mb-0">${{ payroll_summary.total_ytd_earnings|floatformat:2 }}</h4>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="stat-item">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <h6 class="mb-1">Average Monthly</h6>
                                                        <small class="text-muted">Based on payments received</small>
                                                    </div>
                                                    <div class="text-end">
                                                        <h5 class="text-primary mb-0">${{ payroll_summary.average_monthly_salary|floatformat:2 }}</h5>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="stat-item">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <h6 class="mb-1">Projected Annual</h6>
                                                        <small class="text-muted">12 months estimate</small>
                                                    </div>
                                                    <div class="text-end">
                                                        <h5 class="text-info mb-0">${{ payroll_summary.projected_annual_salary|floatformat:2 }}</h5>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tax & Benefits Information - Now with compact styling -->
                    <div class="col-lg-4">
                        <div class="card tax-benefits-card">
                            <div class="card-header">
                                <h6 class="card-title mb-0">
                                    <i class="bi bi-shield-check"></i> Tax & Benefits Info
                                </h6>
                            </div>
                            <div class="card-body">
                                <!-- Tax Information -->
                                <div class="info-section">
                                    <h6 class="section-title">
                                        <i class="bi bi-file-earmark-text text-warning"></i> Tax Information
                                    </h6>
                                    <div class="info-list">
                                        <div class="d-flex justify-content-between">
                                            <span>Tax Deducted (YTD)</span>
                                            <strong class="text-danger">${{ payroll_summary.total_tax_deducted|floatformat:2 }}</strong>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>Tax Rate</span>
                                            <span class="text-muted">15%</span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>Tax Bracket</span>
                                            <span class="badge bg-info">Standard</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Benefits Information -->
                                <div class="info-section">
                                    <h6 class="section-title">
                                        <i class="bi bi-heart text-success"></i> Benefits Package
                                    </h6>
                                    <div class="benefits-list">
                                        <div class="benefit-item">
                                            <i class="bi bi-check-circle text-success me-2"></i>
                                            <span>Health Insurance</span>
                                        </div>
                                        <div class="benefit-item">
                                            <i class="bi bi-check-circle text-success me-2"></i>
                                            <span>Retirement Plan (401k)</span>
                                        </div>
                                        <div class="benefit-item">
                                            <i class="bi bi-check-circle text-success me-2"></i>
                                            <span>Paid Time Off</span>
                                        </div>
                                        <div class="benefit-item">
                                            <i class="bi bi-check-circle text-success me-2"></i>
                                            <span>Life Insurance</span>
                                        </div>
                                    </div>
                                </div>

                                
                            </div>
                        </div>
                    </div>
                </div>
            {% endwith %}
        {% endif %}

        <!-- Payroll History -->
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-clock-history"></i> Payroll History
                    </h5>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary btn-sm active">All</button>
                        <button type="button" class="btn btn-outline-primary btn-sm">2025</button>
                        <button type="button" class="btn btn-outline-primary btn-sm">2024</button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                {% if payroll_records %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th><i class="bi bi-calendar-month"></i> Period</th>
                                    <th><i class="bi bi-cash"></i> Basic Salary</th>
                                    <th><i class="bi bi-plus-circle"></i> Allowances</th>
                                    <th><i class="bi bi-dash-circle"></i> Deductions</th>
                                    <th><i class="bi bi-cash-coin"></i> Net Salary</th>
                                    <th><i class="bi bi-calendar-check"></i> Paid Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for payroll in payroll_records %}
                                    <tr class="fade-in-up">
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="period-icon me-2">
                                                    <i class="bi bi-calendar3"></i>
                                                </div>
                                                <div>
                                                    <strong>{{ payroll.payment_date|date:"F Y" }}</strong>
                                                    <br><small class="text-muted">{{ payroll.payment_date|date:"M j" }}</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="text-primary">
                                            <strong>${{ payroll.basic_salary|floatformat:2 }}</strong>
                                        </td>
                                        <td class="text-info">
                                            <strong>+${{ payroll.allowances|floatformat:2 }}</strong>
                                        </td>
                                        <td class="text-danger">
                                            <strong>-${{ payroll.deductions|floatformat:2 }}</strong>
                                        </td>
                                        <td>
                                            <div class="net-salary-cell">
                                                <strong class="text-success fs-5">${{ payroll.net_salary|floatformat:2 }}</strong>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <i class="bi bi-check-circle text-success me-2"></i>
                                                <div>
                                                    <div>{{ payroll.payment_date|date:"M d, Y" }}</div>
                                                    <small class="text-muted">Processed</small>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Export Button -->
                    <div class="text-center mt-4">
                        <button class="btn btn-outline-success" id="export-payroll-btn-main" onclick="exportPayrollReport()">
                            <i class="bi bi-download me-2"></i> Export Payroll Report
                        </button>
                    </div>
                {% else %}
                    <div class="empty-state">
                        <i class="bi bi-cash-stack"></i>
                        <h4>No Payroll Records</h4>
                        <p>No payroll information available at the moment. Please contact HR for assistance.</p>
                        <button class="btn btn-primary mt-3">
                            <i class="bi bi-envelope"></i> Contact HR
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</main>

<script>
// Function to export payroll report
function exportPayrollReport() {
  const employeeId = '{{ employee.employee_id }}';
  const exportBtns = document.querySelectorAll('[id^="export-payroll-btn"]');
  
  // Show loading state on all export buttons
  exportBtns.forEach(btn => {
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-clock-history"></i> Generating...';
    btn.disabled = true;
    
    // Store original text for later restoration
    btn.setAttribute('data-original-text', originalText);
  });
  
  // Build export URL
  const exportUrl = `{% url 'export-payroll' employee.employee_id %}`;
  
  // Create a temporary link element and trigger download
  const link = document.createElement('a');
  link.href = exportUrl;
  link.download = ''; // Let the server determine filename
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  // Reset button states after a short delay
  setTimeout(() => {
    exportBtns.forEach(btn => {
      const originalText = btn.getAttribute('data-original-text');
      btn.innerHTML = originalText;
      btn.disabled = false;
      btn.removeAttribute('data-original-text');
    });
  }, 2000);
}

// Initialize Chart.js for earnings trend
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('earningsChart');
    if (ctx) {
        {% if payroll_records %}
            // Prepare data for earnings trend (last 6 months or available records)
            const payrollData = [
                {% for payroll in payroll_records|slice:":6" reversed %}
                {
                    month: '{{ payroll.payment_date|date:"M Y" }}',
                    basic: {{ payroll.basic_salary }},
                    allowances: {{ payroll.allowances }},
                    deductions: {{ payroll.deductions }},
                    net: {{ payroll.net_salary }}
                },
                {% endfor %}
            ];
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: payrollData.map(data => data.month),
                    datasets: [
                        {
                            label: 'Net Salary',
                            data: payrollData.map(data => data.net),
                            borderColor: 'rgba(40, 167, 69, 1)',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Basic Salary',
                            data: payrollData.map(data => data.basic),
                            borderColor: 'rgba(13, 110, 253, 1)',
                            backgroundColor: 'rgba(13, 110, 253, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': $' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        {% endif %}
    }
});

// Initialize tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

// Animate table rows
document.addEventListener('DOMContentLoaded', function() {
    const rows = document.querySelectorAll('tbody tr');
    rows.forEach((row, index) => {
        setTimeout(() => {
            row.style.opacity = '1';
            row.style.transform = 'translateY(0)';
        }, index * 100);
    });
});

// Filter functionality
document.addEventListener('DOMContentLoaded', function() {
    const filterButtons = document.querySelectorAll('.btn-group .btn');
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Remove active class from all buttons
            filterButtons.forEach(btn => btn.classList.remove('active'));
            // Add active class to clicked button
            this.classList.add('active');
            
            // Here you would implement the actual filtering logic
            console.log('Filter by:', this.textContent);
        });
    });
});
</script>

{% endblock content %}